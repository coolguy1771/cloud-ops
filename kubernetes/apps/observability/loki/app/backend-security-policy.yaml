---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/gateway.envoyproxy.io/securitypolicy_v1alpha1.json
# JWT auth for Loki backend (ruler + compactor). Ruler: loki:read, compactor delete: loki:write.
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: loki-backend-jwt
  namespace: observability
spec:
  targetSelectors:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      matchLabels:
        app: loki-backend
  jwt:
    providers:
      - name: duo-m2m
        issuer: "https://sso-3da0e7d4.sso.duosecurity.com/oauth/DIV21P82KMG9NOTNQW6J"
        remoteJWKS:
          uri: "https://sso-3da0e7d4.sso.duosecurity.com/oauth/DIV21P82KMG9NOTNQW6J/jwks"
        claimToHeaders:
          - claim: sub
            header: X-Scope-OrgID
  authorization:
    defaultAction: Deny
    rules:
      - name: require-read-scope
        action: Allow
        principal:
          jwt:
            provider: duo-m2m
            scopes:
              - loki:read
      - name: require-write-scope
        action: Allow
        principal:
          jwt:
            provider: duo-m2m
            scopes:
              - loki:write
