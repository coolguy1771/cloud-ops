---
# HTTPRoute for Mimir write paths (machine-to-machine, Basic Auth)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mimir-write
  namespace: monitoring
  labels:
    app: mimir-write
  annotations:
    external-dns.alpha.kubernetes.io/hostname: mimir.dev.icbplays.net
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "mimir.dev.icbplays.net"
  rules:
    # Mimir write path (Prometheus remote write)
    - matches:
        - path:
            type: PathPrefix
            value: /api/v1/push
      backendRefs:
        - name: mimir-distributor
          port: 8080
          weight: 1
    # OTLP write path (for OpenTelemetry)
    - matches:
        - path:
            type: PathPrefix
            value: /otlp
      backendRefs:
        - name: mimir-distributor
          port: 8080
          weight: 1
---
# HTTPRoute for Mimir read/UI paths (browser access, OIDC)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: mimir
  namespace: monitoring
  labels:
    app: mimir
  annotations:
    external-dns.alpha.kubernetes.io/hostname: mimir.dev.icbplays.net
spec:
  parentRefs:
    - name: envoy-external
      namespace: network
      sectionName: https
  hostnames:
    - "mimir.dev.icbplays.net"
  rules:
    # Mimir query path (Prometheus API compatible)
    - matches:
        - path:
            type: PathPrefix
            value: /prometheus
      backendRefs:
        - name: mimir-query-frontend
          port: 8080
          weight: 1
    # Default route (status, config, memberlist, etc.)
    - backendRefs:
        - name: mimir-gateway
          port: 80
          weight: 1
